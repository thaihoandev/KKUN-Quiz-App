spring:
  application:
    name: ${SPRING_APPLICATION_NAME:kkun-quiz}

  jackson:
    time-zone: Asia/Ho_Chi_Minh
    serialization:
      write-dates-as-timestamps: false

  # ==================== DATABASE & JPA ====================
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/kkunquizapp}
    username: ${SPRING_DATASOURCE_USERNAME:postgres}
    password: ${SPRING_DATASOURCE_PASSWORD:123456}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 15
      minimum-idle: 5
      connection-timeout: 20000

  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        format_sql: true
        temp:
          use_jdbc_metadata_defaults: false
        jdbc:
          time_zone: Asia/Ho_Chi_Minh
          batch_size: 25
        order_inserts: true
        order_updates: true
        globally_quoted_identifiers: true
        globally_quoted_identifiers_skip_column_definitions: true
        types:
          json: org.hibernate.type.json.JsonType
    show-sql: false
    open-in-view: false

  # ==================== REDIS (Upstash + Local) ====================
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: 0
      timeout: 6000ms
      ssl:
        enabled: ${REDIS_SSL_ENABLED:true}
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
          max-wait: 2000ms

  cache:
    type: redis
    redis:
      time-to-live: 600000      # 10 phút
      cache-null-values: false
      use-key-prefix: true
      key-prefix: "kkun:"

  # ==================== KAFKA FULL CONFIG ====================
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    client-id: ${spring.application.name}-client

    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
      acks: 1
      properties:
        spring.json.add.type.headers: false

    consumer:
      group-id: ${KAFKA_GROUP_ID:kkun-quiz-group}
      auto-offset-reset: earliest
      enable-auto-commit: false
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.kkunquizapp.QuizAppBackend.*"

    listener:
      ack-mode: record
      missing-topics-fatal: false

    properties:
      security.protocol: ${KAFKA_SECURITY_PROTOCOL:PLAINTEXT}
      sasl.mechanism: ${KAFKA_SASL_MECHANISM:}
      sasl.jaas.config: ${KAFKA_SASL_JAAS:}
      ssl.endpoint.identification.algorithm: ${KAFKA_SSL_ENDPOINT_ID:https}
      request.timeout.ms: 8000
      default.api.timeout.ms: 10000
      session.timeout.ms: 30000
      heartbeat.interval.ms: 3000
      metadata.max.age.ms: 60000

    admin:
      auto-create: false
      fail-fast: false

  # ==================== MAIL ====================
  mail:
    host: smtp.gmail.com
    port: 587
    username: ${MAIL_USERNAME:}
    password: ${MAIL_APP_PASSWORD:}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true

  # ==================== MULTIPART ====================
  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 20MB

  # ==================== SECURITY & OAUTH2 ====================
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: https://accounts.google.com
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID:}
            client-secret: ${GOOGLE_CLIENT_SECRET:}
            scope:
              - openid
              - profile
              - email
            redirect-uri: "{baseUrl}/login/oauth2/code/google"
        provider:
          google:
            issuer-uri: https://accounts.google.com

# ==================== SERVER & HTTP CLIENT ====================
server:
  port: ${PORT:8080}

http:
  connect-timeout-ms: ${HTTP_CONNECT_TIMEOUT_MS:10000}
  read-timeout-ms: ${HTTP_READ_TIMEOUT_MS:100000}
  write-timeout-ms: ${HTTP_WRITE_TIMEOUT_MS:100000}
  max-in-memory-size: ${HTTP_MAX_IN_MEMORY_SIZE:8388608}

# ==================== CUSTOM APP CONFIG ====================
app:
  cors:
    allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:5173,https://kkun-quiz.vercel.app}
  supportEmail: no-reply@kkun-quiz.com
  kafka:
    topics:
      chat-send: chat.message.send
      chat-created: chat.message.created
      game-events: game-events

jwt:
  public-key-path: ${JWT_PUBLIC_KEY_PATH:classpath:keys/public_key.pem}
  private-key-path: ${JWT_PRIVATE_KEY_PATH:classpath:keys/private_key.pem}
  public-key: ${JWT_PUBLIC_KEY:}
  private-key: ${JWT_PRIVATE_KEY:}

cloudinary:
  cloud-name: ${CLOUDINARY_NAME:}
  api-key: ${CLOUDINARY_API_KEY:}
  api-secret: ${CLOUDINARY_API_SECRET:}

gemini:
  api:
    key: ${GEMINI_API_KEY:}
    model: ${GEMINI_MODEL:gemini-2.0-flash}
    max-output-tokens: ${GEMINI_MAX_OUTPUT_TOKENS:4096}
    temperature: ${GEMINI_TEMPERATURE:0.1}
    top-p: ${GEMINI_TOP_P:0.8}
    candidate-count: ${GEMINI_CANDIDATE_COUNT:1}
    retry:
      max-attempts: ${GEMINI_RETRY_MAX_ATTEMPTS:4}
      initial-backoff-ms: ${GEMINI_RETRY_INITIAL_MS:400}
      max-backoff-ms: ${GEMINI_RETRY_MAX_MS:4000}
      jitter: ${GEMINI_RETRY_JITTER:true}
  client:
    timeout-seconds: 50
    max-connections: 10
    max-pending-requests: 100

limits:
  max-questions: ${MAX_QUESTIONS:10}
  max-topic-chars: ${MAX_TOPIC_CHARS:300}

# ==================== LOGGING & ACTUATOR ====================
logging:
  level:
    root: INFO
    com.kkunquizapp: INFO
    org.springframework: INFO

    # Tắt toàn bộ log SQL
    org.hibernate.SQL: OFF
    org.hibernate.orm.jdbc.bind: OFF
    org.hibernate.type.descriptor.sql: OFF

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always